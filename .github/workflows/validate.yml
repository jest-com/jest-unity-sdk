name: Validate & Test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate package structure
        run: |
          echo "ðŸ“¦ Checking package structure..."

          # Required files
          for file in package.json README.md CHANGELOG.md; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            fi
            echo "âœ… Found: $file"
          done

          # Required folders
          for folder in Runtime Editor Tests; do
            if [ ! -d "$folder" ]; then
              echo "âŒ Missing required folder: $folder"
              exit 1
            fi
            echo "âœ… Found: $folder/"
          done

          # Validate package.json
          echo ""
          echo "ðŸ“‹ Package info:"
          jq -r '"  Name: \(.name)\n  Version: \(.version)\n  Unity: \(.unity)"' package.json

          echo ""
          echo "âœ… Package structure is valid!"

  test:
    runs-on: ubuntu-latest
    needs: validate
    env:
      UNITY_VERSION: 2022.3.20f1
      TEST_PROJECT: .test-project
    steps:
      - uses: actions/checkout@v4

      - name: Create minimal Unity test project
        run: |
          mkdir -p $TEST_PROJECT/Assets
          mkdir -p $TEST_PROJECT/ProjectSettings
          mkdir -p $TEST_PROJECT/Packages

          # Create manifest.json that imports SDK from parent
          cat > $TEST_PROJECT/Packages/manifest.json << 'EOF'
          {
            "dependencies": {
              "com.jest.sdk": "file:../../",
              "com.unity.test-framework": "1.3.9",
              "com.unity.nuget.newtonsoft-json": "3.2.1"
            },
            "testables": ["com.jest.sdk"]
          }
          EOF

          # Create minimal ProjectSettings
          cat > $TEST_PROJECT/ProjectSettings/ProjectVersion.txt << EOF
          m_EditorVersion: $UNITY_VERSION
          EOF

          # Create minimal ProjectSettings.asset
          cat > $TEST_PROJECT/ProjectSettings/ProjectSettings.asset << 'EOF'
          %YAML 1.1
          %TAG !u! tag:unity3d.com,2011:
          --- !u!129 &1
          PlayerSettings:
            productName: SDK Test Project
            companyName: Jest
          EOF

          echo "âœ… Created minimal test project at $TEST_PROJECT"
          ls -la $TEST_PROJECT/
          cat $TEST_PROJECT/Packages/manifest.json

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          docker-images: true
          large-packages: false

      - name: Run Unity Tests
        id: tests
        uses: game-ci/unity-test-runner@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: ${{ env.TEST_PROJECT }}
          testMode: EditMode
          unityVersion: ${{ env.UNITY_VERSION }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          checkName: Unity Test Results

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unity-test-results
          path: ${{ steps.tests.outputs.artifactsPath }}
          retention-days: 7
